<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <!-- Règles de sécurité (inchangées) -->
    <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline'; /* unsafe-inline nécessaire pour le script intégré */
    style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; /* unsafe-inline pour styles intégrés, cloudflare pour font-awesome */
    connect-src 'self' https://api.whatalead.app;
    img-src 'self' data: https://upload.wikimedia.org blob:;
    font-src 'self' https://cdnjs.cloudflare.com; /* Autoriser les polices font-awesome */
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
  ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <title>Chatbot & WhatsApp Widget</title>

<!-- Ajout de Font Awesome pour les icônes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
    /* Styles CSS (inchangés par rapport à votre version originale) */
   :root { /* ... variables ... */
        --bubble-gradient-start: #007BFF; --bubble-gradient-end: #00C6FF;
        --header-gradient-start: #007BFF; --header-gradient-end: #00C6FF;
        --header-text-color: #fff; --chat-bg-color: #fff; --chat-body-bg: #f7f9fc;
        --bot-bubble-bg: #e9ecef; --user-bubble-bg: #007BFF; --user-bubble-text-color: #fff;
        --chat-border-radius: 12px; --bubble-border-radius: 50%; --msg-border-radius: 10px;
        --transition-duration: 0.3s; --box-shadow-intense: 0 10px 25px rgba(0,0,0,0.12);
        --box-shadow-soft: 0 4px 10px rgba(0,0,0,0.1);
        --whatsapp-green: #25D366;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; color: #333; } /* Note: le body du site hôte sera stylé, peut être à ajuster */
    #chat-container { display: none; /* Géré par JS */ position: fixed; bottom: 95px; right: 20px; width: min(370px, 90vw); height: 520px; background: var(--chat-bg-color); border-radius: var(--chat-border-radius); box-shadow: var(--box-shadow-intense); z-index: 2000; flex-direction: column; overflow: hidden; transition: all var(--transition-duration) ease; opacity: 0; transform: translateY(20px) scale(0.95); }
    #chat-container.active { opacity: 1; transform: translateY(0) scale(1); }
    #chat-window { display: flex; flex-direction: column; height: 100%; }
    #chat-window-header { display: flex; align-items: center; padding: 12px 15px; background: linear-gradient(135deg, var(--header-gradient-start), var(--header-gradient-end)); color: var(--header-text-color); border-top-left-radius: var(--chat-border-radius); border-top-right-radius: var(--chat-border-radius); flex-shrink: 0; }
    #chat-header-avatar { display: none; /* Affiché par JS si URL fournie */ width: 36px; height: 36px; border-radius: 50%; margin-right: 12px; object-fit: cover; border: 2px solid rgba(255, 255, 255, 0.5); }
    #header-info { flex-grow: 1; display: flex; flex-direction: column; }
    #chat-window-header h4 { font-size: 1.05rem; font-weight: 600; line-height: 1.2; margin-bottom: 2px; } /* Ajustement marge */
    #online-indicator { font-size: 0.8rem; display: flex; align-items: center; opacity: 0.85; }
    #online-indicator::before { content: ""; display: inline-block; width: 7px; height: 7px; background-color: #34C759; border-radius: 50%; margin-right: 5px; }
    #chat-close { background: none; border: none; font-size: 1.4rem; color: var(--header-text-color); cursor: pointer; transition: transform 0.2s, opacity 0.2s; padding: 5px; margin-left: 10px; opacity: 0.8; }
    #chat-close:hover { transform: scale(1.1); opacity: 1; }
    #chat-window-body { flex: 1; padding: 15px; overflow-y: auto; background: var(--chat-body-bg); display: flex; flex-direction: column; }
    .bot-message, .user-message { margin: 6px 0; padding: 10px 14px; border-radius: var(--msg-border-radius); max-width: 85%; line-height: 1.45; box-shadow: 0 1px 1px rgba(0,0,0,0.05); animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .bot-message { background: var(--bot-bubble-bg); align-self: flex-start; color: #212529; border-bottom-left-radius: 4px; }
    .user-message { background: var(--user-bubble-bg); color: var(--user-bubble-text-color); align-self: flex-end; margin-left: auto; border-bottom-right-radius: 4px; }
    #chat-window-footer { display: flex; padding: 10px 15px; border-top: 1px solid #e0e0e0; background: #fff; flex-shrink: 0; }
    #chat-input { flex: 1; padding: 10px 15px; border: 1px solid #ced4da; border-radius: 20px; margin-right: 10px; outline: none; font-size: 0.95rem; transition: border-color 0.3s, box-shadow 0.3s; }
    #chat-input:focus { border-color: var(--bubble-gradient-start); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.15); }
    #chat-send { padding: 9px 18px; background: linear-gradient(135deg, var(--header-gradient-start), var(--header-gradient-end)); color: #fff; border: none; border-radius: 20px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: all 0.2s ease-out; box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2); }
    #chat-send:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0, 123, 255, 0.25); }
    #chat-send:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0, 123, 255, 0.2); }
    #chat-footer-info { text-align: center; padding: 8px; font-size: 11px; color: #888; background: #f8f9fa; border-bottom-left-radius: var(--chat-border-radius); border-bottom-right-radius: var(--chat-border-radius); flex-shrink: 0; }
    #chat-footer-info a { color: #6c757d; text-decoration: none; transition: color 0.2s; }
    #chat-footer-info a:hover { color: #0056b3; text-decoration: underline; }
    #chat-bubble { display: none; /* Géré par JS */ position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; background: linear-gradient(135deg, var(--bubble-gradient-start), var(--bubble-gradient-end)); border-radius: var(--bubble-border-radius); box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3); cursor: pointer; z-index: 3000; justify-content: center; align-items: center; transition: all var(--transition-duration) ease-out; }
    #chat-bubble:hover { transform: scale(1.08); box-shadow: 0 8px 22px rgba(0, 123, 255, 0.35); }
    #chat-bubble svg { width: 30px; height: 30px; fill: var(--header-text-color); }
    #notification-badge { display: none; /* Affiché par JS si badgeContent fourni */ position: absolute; top: -5px; right: -5px; min-width: 22px; height: 22px; background: #DC3545; color: #fff; font-size: 12px; text-align: center; line-height: 22px; border-radius: 50%; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pulse 1.5s infinite; padding: 0 5px; }
    @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); } 50% { transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.3); } 100% { transform: scale(1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); } }
    #help-text { display: none; /* Affiché par JS si helpText fourni */ position: fixed; bottom: 35px; right: 95px; background: #343a40; color: #fff; padding: 9px 15px; border-radius: 8px; font-size: 13px; z-index: 2500; box-shadow: var(--box-shadow-soft); animation: fadeInHelp 0.5s ease-out; white-space: nowrap; }
    @keyframes fadeInHelp { from { opacity: 0; transform: translateX(15px); } to { opacity: 1; transform: translateX(0); } }
    .typing-indicator .dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: rgba(0,0,0,0.4); margin: 0 2px; animation: typingDots 1.2s infinite ease-in-out; }
    .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typingDots { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-4px); } }
    #whatsapp-button-container { display: none; /* Géré par JS */ position: fixed; bottom: 20px; right: 20px; z-index: 3000; flex-direction: row-reverse; align-items: center; }
    #whatsapp-text { display: none; /* Affiché par JS si whatsappHelpText fourni */ background: #fff; color: #333; padding: 9px 14px; border-radius: 8px; font-size: 13px; margin-right: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); animation: fadeInHelp 0.5s ease; white-space: nowrap; }
    #whatsapp-button { background-color: var(--whatsapp-green); border: none; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
    #whatsapp-button:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2); }
    #whatsapp-button i { font-size: 32px; color: white; } /* Style pour l'icône Font Awesome */
    #whatsapp-badge { display: none; /* Affiché par JS si whatsappBadgeContent fourni */ position: absolute; top: -5px; right: -5px; min-width: 22px; height: 22px; background: #DC3545; color: #fff; font-size: 12px; text-align: center; line-height: 22px; border-radius: 50%; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pulse 1.5s infinite; padding: 0 5px; }
</style>

</head>
<body>

<!-- HTML Structure -->
<div id="chat-container">
    <div id="chat-window">
        <div id="chat-window-header">
            <img id="chat-header-avatar" src="" alt="Avatar">
            <div id="header-info">
                <h4 id="chat-title">Chatbot</h4>
                <span id="online-indicator">En ligne</span>
            </div>
            <button id="chat-close" aria-label="Fermer le chat">✕</button>
        </div>
        <div id="chat-window-body" aria-live="polite"></div>
        <div id="chat-window-footer">
            <input type="text" id="chat-input" placeholder="Écrire un message..." aria-label="Votre message" autocomplete="off">
            <button id="chat-send">Envoyer</button>
        </div>
        <div id="chat-footer-info">
            <a href="https://whatalead.app" target="_blank" rel="noopener noreferrer" title="Whatalead">Powered by Whatalead</a>
        </div>
    </div>
</div>

<div id="chat-bubble">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M21.99 4c0-1.1-.89-2-1.99-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14l4 4-.01-18zM18 14H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/></svg>
    <div id="notification-badge"></div> <!-- Contenu géré par JS -->
</div>

<div id="help-text"></div> <!-- Contenu géré par JS -->

<div id="whatsapp-button-container">
    <button id="whatsapp-button" aria-label="Contacter via WhatsApp">
        <i class="fab fa-whatsapp"></i> <!-- Icône via FontAwesome -->
        <div id="whatsapp-badge"></div> <!-- Contenu géré par JS -->
    </button>
    <div id="whatsapp-text"></div> <!-- Contenu géré par JS -->
</div>


<script>
    // Vérifie que les objets de configuration sont bien chargés
    if (typeof GlobalConfig === 'undefined' || typeof ChatbotUIConfig === 'undefined' || typeof WhatsAppUIConfig === 'undefined') {
        console.error("Erreur critique : Les fichiers de configuration (config.js) n'ont pas été chargés avant chatbot.js.");
        // Optionnel : Afficher un message d'erreur à l'utilisateur dans la console ou même sur la page
    } else {

        /***********************************************
         * FONCTIONS UTILITAIRES
         ***********************************************/
        function loadChatHistory() {
            const h = sessionStorage.getItem('chatHistory');
            return h ? JSON.parse(h) : [];
        }

        function saveChatHistory(history) {
            sessionStorage.setItem('chatHistory', JSON.stringify(history));
        }

        async function initializeChatSession(initialWebhookURL) {
            console.log("Initialisation de la session de chat...");
            let conversationId = sessionStorage.getItem('websiteConvId');
            const payload = { current_webpage: window.location.href };

            if (conversationId) {
                console.log("ID de conversation existant trouvé:", conversationId);
                payload.websiteConvId = conversationId;
            } else {
                console.log("Aucun ID de conversation existant, demande d'un nouveau.");
            }

            try {
                const response = await fetch(initialWebhookURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status} lors de l'initialisation.`);
                }

                // Si on n'avait pas d'ID, on essaie de le récupérer de la réponse
                if (!conversationId) {
                    const data = await response.json();
                    if (data && data.websiteConvId) {
                        conversationId = data.websiteConvId;
                        sessionStorage.setItem('websiteConvId', conversationId);
                        console.log("Nouvel ID de conversation reçu et stocké:", conversationId);
                    } else {
                        console.error("Réponse d'initialisation reçue, mais l'ID de conversation est manquant.");
                        return null; // Échec de l'obtention de l'ID
                    }
                } else {
                    console.log("Session initialisée avec l'ID de conversation existant.");
                    // Optionnellement, traiter la réponse même si l'ID existait déjà
                    // const data = await response.json(); // Si la réponse contient des infos utiles
                }
            } catch (error) {
                console.error("Erreur lors de l'initialisation de la session de chat:", error);
                // On retourne l'ID existant s'il y en avait un, même si l'appel échoue,
                // pour potentiellement continuer avec l'ancien ID.
                return sessionStorage.getItem('websiteConvId');
            }
            return conversationId;
        }

        // Fonction Debounce
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /***********************************************
         * LOGIQUE PRINCIPALE DU WIDGET
         ***********************************************/
        document.addEventListener("DOMContentLoaded", async () => {

            /* Références DOM */
            const chatContainer = document.getElementById("chat-container");
            const chatBubble = document.getElementById("chat-bubble");
            const chatClose = document.getElementById("chat-close");
            const chatTitle = document.getElementById("chat-title");
            const chatAvatar = document.getElementById("chat-header-avatar");
            const chatInput = document.getElementById("chat-input");
            const chatSend = document.getElementById("chat-send");
            const chatBody = document.getElementById("chat-window-body");
            const helpTextElement = document.getElementById("help-text"); // Renommé pour clarté
            const notificationBadge = document.getElementById("notification-badge");
            const whatsappButtonContainer = document.getElementById("whatsapp-button-container");
            const whatsappTextElement = document.getElementById("whatsapp-text"); // Renommé pour clarté
            const whatsappButton = document.getElementById("whatsapp-button");
            const whatsappBadge = document.getElementById("whatsapp-badge");

            let conversationId = null;
            let chatHistory = [];
            let activeMode = 'none';
            let helpTextTimerId = null;
            let helpTextHideTimerId = null;
            let whatsappTimerId = null;
            let whatsappHideTimerId = null;

            // 1. Déterminer le mode actif
            if (GlobalConfig.enableChatbot && GlobalConfig.enableWhatsApp) activeMode = 'both';
            else if (GlobalConfig.enableChatbot) activeMode = 'chatbot_only';
            else if (GlobalConfig.enableWhatsApp) activeMode = 'whatsapp_only';

             // Si aucun mode n'est actif, ne rien faire de plus
            if (activeMode === 'none') {
                console.log("Chatbot et WhatsApp désactivés.");
                return; // Sortir tôt
            }

            // 2. Initialiser l'ID si le chatbot est actif
            if (activeMode === 'chatbot_only' || activeMode === 'both') {
                if (ChatbotUIConfig.initialWebhookURL && ChatbotUIConfig.messageWebhookURL) {
                    conversationId = await initializeChatSession(ChatbotUIConfig.initialWebhookURL);
                    if (conversationId) {
                        chatHistory = loadChatHistory();
                    } else {
                        console.error("Échec de l'initialisation de l'ID de conversation. Le chatbot pourrait ne pas fonctionner.");
                        // Décider si on désactive le chatbot en cas d'échec ? Pour l'instant on continue.
                        // activeMode = GlobalConfig.enableWhatsApp ? 'whatsapp_only' : 'none'; // Exemple de fallback
                    }
                } else {
                     console.warn("URLs de webhook manquantes dans ChatbotUIConfig. Le chatbot ne peut pas être initialisé.");
                     // Si WhatsApp est activé, on passe en mode WhatsApp seulement
                     if (activeMode === 'both' && GlobalConfig.enableWhatsApp) {
                         activeMode = 'whatsapp_only';
                     } else {
                         activeMode = 'none'; // Désactiver complètement si seul le chatbot était prévu
                         return; // Sortir
                     }
                }
            }

            // 3. Fonctions UI et Timers (basées sur la config chargée)
            const initChatbotUI = () => {
                if (ChatbotUIConfig.chatbotName && chatTitle) chatTitle.textContent = ChatbotUIConfig.chatbotName;
                if (ChatbotUIConfig.helpText && helpTextElement) helpTextElement.textContent = ChatbotUIConfig.helpText;
                if (ChatbotUIConfig.badgeContent && notificationBadge) notificationBadge.textContent = ChatbotUIConfig.badgeContent;

                if (ChatbotUIConfig.avatarURL && chatAvatar) {
                     chatAvatar.src = ChatbotUIConfig.avatarURL;
                     chatAvatar.style.display = 'block';
                 } else if (chatAvatar) {
                     chatAvatar.style.display = 'none'; // Cacher si pas d'URL
                 }
            };

            const initWhatsAppUI = () => {
                if (WhatsAppUIConfig.whatsappHelpText && whatsappTextElement) whatsappTextElement.textContent = WhatsAppUIConfig.whatsappHelpText;
                if (WhatsAppUIConfig.whatsappBadgeContent && whatsappBadge) whatsappBadge.textContent = WhatsAppUIConfig.whatsappBadgeContent;
            };

            const clearTimers = () => {
                if (helpTextTimerId) clearTimeout(helpTextTimerId);
                if (helpTextHideTimerId) clearTimeout(helpTextHideTimerId);
                if (whatsappTimerId) clearTimeout(whatsappTimerId);
                if (whatsappHideTimerId) clearTimeout(whatsappHideTimerId);
                helpTextTimerId = helpTextHideTimerId = whatsappTimerId = whatsappHideTimerId = null;
            };

            const runChatbotTimers = () => {
                clearTimers(); // Assure qu'un seul type de timer tourne à la fois
                // Afficher le texte d'aide seulement s'il est défini
                if (ChatbotUIConfig.helpText && helpTextElement) {
                    helpTextTimerId = setTimeout(() => {
                        helpTextElement.style.display = "block";
                        // Afficher le badge seulement s'il est défini
                        if (ChatbotUIConfig.badgeContent && notificationBadge) {
                            notificationBadge.style.display = "block";
                        }
                        // Cacher le texte d'aide après la durée définie (si > 0)
                        if (ChatbotUIConfig.helpTextDisplayDuration > 0) {
                            helpTextHideTimerId = setTimeout(() => {
                                helpTextElement.style.display = "none";
                            }, ChatbotUIConfig.helpTextDisplayDuration);
                        }
                    }, ChatbotUIConfig.helpTextDelay || 0); // Utilise 0 si delay non défini
                } else if (ChatbotUIConfig.badgeContent && notificationBadge) {
                    // Si pas de helpText mais un badge, afficher le badge directement (ou avec délai?)
                    // Pour l'instant, on le lie à l'affichage du helpText. Si on veut le découpler :
                     helpTextTimerId = setTimeout(() => {
                        notificationBadge.style.display = "block";
                    }, ChatbotUIConfig.helpTextDelay || 0);
                }
            };

            const runWhatsAppTimers = () => {
                clearTimers(); // Assure qu'un seul type de timer tourne à la fois
                 // Afficher le texte d'aide WhatsApp seulement s'il est défini
                if (WhatsAppUIConfig.whatsappHelpText && whatsappTextElement) {
                    whatsappTimerId = setTimeout(() => {
                        whatsappTextElement.style.display = "block";
                         // Afficher le badge WhatsApp seulement s'il est défini
                        if (WhatsAppUIConfig.whatsappBadgeContent && whatsappBadge) {
                            whatsappBadge.style.display = "block";
                        }
                         // Cacher le texte d'aide après la durée définie (si > 0)
                        if (WhatsAppUIConfig.whatsappHelpDisplayDuration > 0) {
                            whatsappHideTimerId = setTimeout(() => {
                                whatsappTextElement.style.display = "none";
                            }, WhatsAppUIConfig.whatsappHelpDisplayDuration);
                        }
                    }, WhatsAppUIConfig.whatsappHelpDelay || 0); // Utilise 0 si delay non défini
                } else if (WhatsAppUIConfig.whatsappBadgeContent && whatsappBadge) {
                    // Si pas de helpText WhatsApp mais un badge, afficher le badge
                     whatsappTimerId = setTimeout(() => {
                         whatsappBadge.style.display = "block";
                     }, WhatsAppUIConfig.whatsappHelpDelay || 0);
                }
            };


            // 4. Fonction pour mettre à jour la visibilité (appelée au load et au resize)
            const updateWidgetVisibility = () => {
                const isCurrentlyMobile = window.innerWidth <= 600;
                console.log(`Mise à jour Visibilité - Mode: ${activeMode}, Mobile: ${isCurrentlyMobile}`);

                // Cacher tout par défaut avant de décider quoi montrer
                if (chatBubble) chatBubble.style.display = 'none';
                if (whatsappButtonContainer) whatsappButtonContainer.style.display = 'none';
                if (helpTextElement) helpTextElement.style.display = 'none';
                if (whatsappTextElement) whatsappTextElement.style.display = 'none';
                if (notificationBadge) notificationBadge.style.display = 'none';
                if (whatsappBadge) whatsappBadge.style.display = 'none';

                // Nettoyer les timers existants avant d'en lancer de nouveaux
                clearTimers();

                switch (activeMode) {
                    case 'chatbot_only':
                        initChatbotUI(); // Appliquer la config
                        if (chatBubble) chatBubble.style.display = 'flex'; // Afficher la bulle
                        runChatbotTimers(); // Lancer les timers pour help/badge
                        break;
                    case 'whatsapp_only':
                        initWhatsAppUI(); // Appliquer la config
                        if (whatsappButtonContainer) whatsappButtonContainer.style.display = 'flex'; // Afficher le bouton WA
                        runWhatsAppTimers(); // Lancer les timers pour help/badge WA
                        break;
                    case 'both':
                        initChatbotUI();
                        initWhatsAppUI();
                        if (isCurrentlyMobile) {
                            // Sur mobile, afficher WhatsApp
                            if (whatsappButtonContainer) whatsappButtonContainer.style.display = 'flex';
                            runWhatsAppTimers();
                        } else {
                            // Sur Desktop, afficher Chatbot
                            if (chatBubble) chatBubble.style.display = 'flex';
                            runChatbotTimers();
                        }
                        break;
                    case 'none':
                    default:
                        // Ne rien faire, tout reste caché
                        break;
                }
                // S'assurer que le chat ouvert est fermé lors du passage sur mobile
                if (isCurrentlyMobile && chatContainer && chatContainer.classList.contains('active')) {
                    chatContainer.classList.remove('active');
                    setTimeout(() => { chatContainer.style.display = 'none'; }, 300); // Laisser le temps à la transition CSS
                    // updateWidgetVisibility sera appelé par le resize, donc le bon bouton (WA) s'affichera
                }
                 // Inversement: si on passe de mobile à desktop et que le chat était fermé, réafficher la bulle chatbot si mode=both
                if (!isCurrentlyMobile && activeMode === 'both' && chatBubble && chatBubble.style.display === 'none' && (!chatContainer || !chatContainer.classList.contains('active'))) {
                     chatBubble.style.display = 'flex';
                     runChatbotTimers(); // Relancer les timers chatbot si besoin
                }
            };

            // 5. Appel initial et écouteur de redimensionnement
            updateWidgetVisibility(); // Appel initial pour définir l'état correct
            window.addEventListener('resize', debounce(updateWidgetVisibility, 250)); // Appel au resize

            // 6. Fonctions et logique Chatbot (si activé)
            const scrollToBottom = () => {
                setTimeout(() => { if (chatBody) chatBody.scrollTop = chatBody.scrollHeight; }, 50);
            }
            const appendMessage = (text, type, skipAnimation = false) => {
                if (!chatBody || !text) return;
                const messageDiv = document.createElement("div");
                const cssClass = type === 'user' ? 'user-message' : 'bot-message';
                messageDiv.classList.add(cssClass);
                messageDiv.textContent = text;
                if (skipAnimation) messageDiv.style.animation = 'none';
                chatBody.appendChild(messageDiv);
                scrollToBottom();
            }
            const showTypingIndicator = () => {
                if (!chatBody || chatBody.querySelector('.typing-indicator')) return;
                const indicatorDiv = document.createElement("div");
                indicatorDiv.classList.add("bot-message", "typing-indicator");
                indicatorDiv.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
                chatBody.appendChild(indicatorDiv);
                scrollToBottom();
            }
            const removeTypingIndicator = () => {
                if (!chatBody) return;
                const indicator = chatBody.querySelector('.typing-indicator');
                if (indicator) chatBody.removeChild(indicator);
            }
            const populateChatFromHistory = () => {
                if (!chatBody) return;
                chatBody.innerHTML = ''; // Vider le chat
                if (chatHistory.length === 0) {
                    // Premier message par défaut si historique vide
                    // Pourrait être configurable via `ChatbotUIConfig.initialMessage` ?
                    appendMessage("Bonjour ! Comment puis-je vous aider ?", 'bot', true);
                    chatHistory.push({ type: 'bot', text: "Bonjour ! Comment puis-je vous aider ?" });
                    // Ne pas sauvegarder ce message initial auto dans l'historique session ? A discuter.
                    // Pour l'instant on le met, mais pas dans saveChatHistory ici.
                } else {
                    chatHistory.forEach(msg => appendMessage(msg.text, msg.type, true)); // true = skip animation
                }
                scrollToBottom();
            }

            const sendMessage = () => {
                if (!conversationId) {
                    console.error("ID de conversation manquant. Impossible d'envoyer le message.");
                    appendMessage("Erreur: Impossible de contacter le serveur (pas d'ID session).", 'bot');
                    return;
                }
                if (!chatInput || !ChatbotUIConfig.messageWebhookURL) {
                     console.error("Input ou URL de webhook message manquants.");
                     return;
                }

                const messageText = chatInput.value.trim();
                if (!messageText) return; // Ne pas envoyer de message vide

                appendMessage(messageText, 'user');
                chatHistory.push({ type: 'user', text: messageText });
                saveChatHistory(chatHistory); // Sauvegarder après ajout user
                chatInput.value = "";
                showTypingIndicator();

                const payload = {
                    message: messageText,
                    websiteConvId: conversationId,
                    // original_url: ChatbotUIConfig.messageWebhookURL, // Peut-être pas nécessaire si c'est la même URL
                    current_webpage: window.location.href
                };

                fetch(ChatbotUIConfig.messageWebhookURL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json"
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    if (!response.ok) {
                        // Essayer de lire le corps de la réponse pour plus de détails sur l'erreur
                        return response.text().then(text => {
                            throw new Error(`Erreur HTTP ${response.status} - ${text || response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    removeTypingIndicator();
                    const replyText = data.reply || data.message || "Désolé, je n'ai pas compris."; // Réponse par défaut
                    appendMessage(replyText, 'bot');
                    chatHistory.push({ type: 'bot', text: replyText });
                    saveChatHistory(chatHistory); // Sauvegarder après ajout bot
                })
                .catch((error) => {
                    console.error("Erreur lors de l'envoi/réception du message:", error);
                    removeTypingIndicator();
                    const errorText = "Une erreur technique est survenue. Veuillez réessayer plus tard.";
                    appendMessage(errorText, 'bot');
                    chatHistory.push({ type: 'bot', text: errorText });
                    saveChatHistory(chatHistory); // Sauvegarder même en cas d'erreur
                });
            }


            // 7. Attacher les Listeners (conditionnellement si les éléments existent)

            // Listeners Chatbot (seulement si chatbot activé et éléments présents)
            if ((activeMode === 'chatbot_only' || activeMode === 'both') && chatBubble && chatContainer && chatClose && chatSend && chatInput) {
                chatBubble.addEventListener("click", () => {
                    clearTimers();
                    if (helpTextElement) helpTextElement.style.display = 'none';
                    if (notificationBadge) notificationBadge.style.display = 'none';
                    populateChatFromHistory();
                    chatContainer.style.display = "flex";
                    // Force reflow pour que la transition fonctionne
                    void chatContainer.offsetWidth;
                    chatContainer.classList.add("active");
                    chatBubble.style.display = "none"; // Cacher la bulle quand le chat est ouvert
                    setTimeout(() => { chatInput.focus(); }, 300); // Focus après transition
                });

                chatClose.addEventListener("click", () => {
                    chatContainer.classList.remove("active");
                    setTimeout(() => {
                        chatContainer.style.display = "none";
                        updateWidgetVisibility(); // Réaffiche le bon bouton (bulle ou WA) et relance les timers si besoin
                    }, 300); // Attendre la fin de la transition CSS
                });

                chatSend.addEventListener("click", sendMessage);

                chatInput.addEventListener("keypress", (e) => {
                    if (e.key === "Enter" && !e.shiftKey) { // Envoyer avec Entrée (sauf si Shift+Entrée)
                        e.preventDefault(); // Empêcher le saut de ligne
                        sendMessage();
                    }
                });
            }

            // Listeners WhatsApp (seulement si WhatsApp activé et éléments présents)
            if ((activeMode === 'whatsapp_only' || activeMode === 'both') && whatsappButton) {
                whatsappButton.addEventListener("click", () => {
                    clearTimers();
                    if (whatsappTextElement) whatsappTextElement.style.display = 'none';
                    if (whatsappBadge) whatsappBadge.style.display = 'none';

                    const whatsappMsg = WhatsAppUIConfig.whatsappMessage || ""; // Utiliser message configuré ou vide
                    const phoneNumber = ""; // A AJOUTER : Le numéro de téléphone cible ! Ex: "33612345678"
                    if (!phoneNumber) {
                        console.warn("Numéro de téléphone WhatsApp non configuré.");
                         // Pourrait ouvrir un lien générique si pas de numéro ?
                         // window.open(`https://wa.me/?text=${encodeURIComponent(whatsappMsg)}`, "_blank");
                         alert("Le contact WhatsApp n'est pas encore configuré."); // Ou une alerte simple
                         return;
                    }
                    const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(whatsappMsg)}`;
                    window.open(url, "_blank");
                });
            }

        }); // Fin DOMContentLoaded

    } // Fin du else (vérification config chargée)

</script>
<!-- Fin du HTML et du Script principal -->
</body>
</html>
